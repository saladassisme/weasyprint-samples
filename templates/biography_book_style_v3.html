<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="author" content="{{ book_info.author }}">
    <title>{{ book_info.title }}</title>
    <style>
        /* 自定义字体定义 */
        @font-face {
            font-family: 'CustomTitle';
            src: url('fonts/custom-title.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* 正文使用系统宋体，无需自定义字体 */
        
        @font-face {
            font-family: 'CustomKai';
            src: url('fonts/custom-kai.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        /* 自定义页面尺寸和样式 */
        @page {
            margin: 2cm 2cm 2cm 2cm;
            size: 140mm 210mm;
        }

        @page :left {
            @bottom-left {
                content: counter(page);
                position: absolute;
                z-index: -1;
                font-size: 10pt;
            }
            @bottom-right {
                content: string(heading);
                position: absolute;
                z-index: -1;
                font-size: 10pt;
            }
        }

        @page :right {
            @bottom-left {
                content: string(heading);
                position: absolute;
                z-index: -1;
                font-size: 10pt;
            }
            @bottom-right {
                content: counter(page);
                position: absolute;
                z-index: -1;
                font-size: 10pt;
            }
        }

        @page full {
            @bottom-right { content: none; }
            @bottom-left { content: none; }
            background: url('file:///C:/Users/xutin/Desktop/小工具/weasyprint-samples/cover_bg.jpg') no-repeat center center;
            background-size: cover;
            margin: 0;
            size: 140mm 210mm;
        }

        @page clean {
            @bottom-right { content: none; }
            @bottom-left { content: none; }
            size: 140mm 210mm;
        }

        @page back-cover {
            @bottom-right { content: none; }
            @bottom-left { content: none; }
            background: url('file:///C:/Users/xutin/Desktop/小工具/weasyprint-samples/封底.jpg') no-repeat center center;
            background-size: cover;
            margin: 0;
            size: 140mm 210mm;
        }

        @page chapter-image :left {
            @bottom-left { 
                content: counter(page);
                font-size: 10pt;
                color: black;
                text-shadow: none;
            }
            @bottom-right { 
                content: string(heading);
                font-size: 10pt;
                color: black;
                text-shadow: none;
            }
            margin: 2cm 2cm 2cm 2cm;
            size: 140mm 210mm;
        }

        @page chapter-image :right {
            @bottom-right { 
                content: counter(page);
                font-size: 10pt;
                color: black;
                text-shadow: none;
            }
            @bottom-left { 
                content: string(heading);
                font-size: 10pt;
                color: black;
                text-shadow: none;
            }
            margin: 2cm 2cm 2cm 2cm;
            size: 140mm 210mm;
        }

        @page chapter-content :left {
            @bottom-left { 
                content: counter(page);
                font-size: 10pt;
            }
            @bottom-right { 
                content: string(heading);
                font-size: 10pt;
            }
            margin: 2cm 2cm 2cm 2cm;
            size: 140mm 210mm;
        }

        @page chapter-content :right {
            @bottom-right { 
                content: counter(page);
                font-size: 10pt;
            }
            @bottom-left { 
                content: string(heading);
                font-size: 10pt;
            }
            margin: 2cm 2cm 2cm 2cm;
            size: 140mm 210mm;
        }

        /* 基础样式 */
        html {
            counter-reset: h2-counter;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif;  /* 默认使用楷体 */
            font-size: 12pt; /* 增大基础字号 */
        }
        
        body {
            margin: 0;
            color: #333;
        }
        
        /* 段落样式 - 正文使用宋体 */
        p {
            line-height: 1.8;
            text-align: justify;
            text-indent: 2em;
            margin: 1em 0;
            font-size: 14pt; /* 增大正文字号从12pt到14pt */
            font-family: "SimSun", "宋体", "NSimSun", serif; /* 正文使用宋体 */
        }
        
        /* 标题样式 */
        h1 {
            position: absolute;
            visibility: hidden;
        }
        
        h2 {
            color: #333; /* 改为深色文字，因为没有了背景装饰 */
            counter-increment: h2-counter;
            display: flex;
            flex-direction: column;
            font-family: 'CustomTitle', "STKaiti", "KaiTi", "楷体", "华文行楷", "STXingkai", serif; /* 优先使用自定义标题字体 */
            font-size: 2.2em; /* 增大章节标题字号 */
            height: auto; /* 改为自动高度，让标题只占用必要的空间 */
            justify-content: flex-start; /* 改为顶部对齐，让标题更靠近顶部 */
            margin: 0;
            padding-top: 0.3cm; /* 减少顶部间距 */
            padding-bottom: 0.1cm; /* 大幅减少底部间距 */
            string-set: heading content();
            text-align: center;
            text-shadow: none; /* 移除文字阴影，因为没有了背景 */
        }
        
        h2::before {
            content: "第" counter(h2-counter) "篇 ";
            display: inline;
            font-size: 0.8em;
            color: #333;
            margin-right: 0.3em;
        }
        
        h3 {
            font-size: 1.8em;
            text-align: center;
            margin: 1.5em 0;
            color: #333;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif; /* 优先使用自定义楷体 */
        }
        
        /* 章节样式 */
        section {
            break-after: right;
        }
        
        .chapter {
            break-after: right;
            position: relative;
            padding-top: 0cm; /* 减少顶部间距，让背景装饰吸顶 */
        }
        
        /* 移除章节装饰背景 */
        .chapter::before {
            display: none; /* 隐藏装饰背景 */
        }
        
        /* 封面样式 - 优化布局 */
        .cover-page {
            page: full;
            color: #2c2c2c; /* 深灰色文字 */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* 改为两端对齐 */
            align-items: center;
            text-align: center;
            padding: 2cm 2cm 3cm 2cm; /* 调整内边距 */
            margin: 0;
            height: 100%;
        }
        
        .cover-title {
            font-size: 2.8em;
            font-weight: bold;
            margin-bottom: 8cm;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3); /* 增强阴影 */
            position: relative;
            z-index: 2;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif; /* 封面标题使用书法字体 */
            letter-spacing: 0.15em;
            color: #1a1a1a; /* 更深的颜色 */
            margin-top: 2.5cm; /* 顶部留白 */
        }
        
        .cover-author {
            font-size: 1.4em;
            position: relative;
            z-index: 2;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif; /* 封面作者使用楷体 */
            letter-spacing: 0.1em;
            color: #2c2c2c;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            margin-bottom: 2cm; /* 底部留白 */
        }
        
        /* 封底样式 */
        .back-cover {
            page: back-cover;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: #666;
        }
        
        .back-cover-content {
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif; /* 封底使用楷体 */
            font-size: 1.2em;
            opacity: 0.7;
        }
        
        /* 空白页样式 */
        .blank-page {
            page: clean;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            break-before: right; /* 强制分页到右页（奇数页） */
            page-break-before: right;
        }
        
        /* 章节左右分页布局 */
        .chapter-image-page {
            page: chapter-image;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            break-before: left; /* 强制分页到左页（偶数页） */
            page-break-before: left;
            /* 如果前一页是偶数页，会自动插入空白页 */
        }
        
        .chapter-image {
            width: 10cm;
            height: auto;
            object-fit: contain;
            display: block;
        }
        
        .chapter-image-page img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .chapter-content-page {
            page: chapter-content;
            padding: 0cm;
            break-before: right; /* 强制分页到右页（奇数页） */
            page-break-before: right;
        }
        
        .chapter-qr {
            text-align: center;
            margin: 0 0 0.5cm 0; /* 完全移除顶部间距 */
        }
        
        .chapter-qr img {
            max-width: 2cm;
            max-height: 2cm;
            border-radius: 4px;
        }
        
        .chapter-qr-label {
            font-size: 9pt;
            color: #666;
            margin-top: 0.2cm;
            font-family: "Microsoft YaHei", sans-serif;
        }
        
        /* 作者信息页 */
        .author-info {
            page: clean;
            text-align: center;
        }
        
        .author-info h3 {
            font-size: 1.8em;
            margin-bottom: 1.5em;
            color: #333;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif;  /* 作者信息标题使用楷体 */
        }
        
        .author-info p {
            font-size: 13pt; /* 增大作者信息字号 */
            line-height: 1.6;
            text-indent: 0;
            margin: 1em 0;
            color: #555;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif; /* 作者信息正文使用楷体 */
        }
        
        /* 目录样式 */
        .contents {
            page: clean;
            counter-reset: page 1; /* 从目录页开始重新计数页码，从1开始 */
        }
        
        /* 确保交叉引用正确工作 */
        .contents a {
            color: #333;
            text-decoration: none;
            display: block;
            padding: 0.3em 0;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif;  /* 目录链接使用楷体 */
        }
        
        .contents h3 {
            font-size: 2em;
            text-align: center;
            margin-bottom: 1.5em;
            color: #333;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif;  /* 目录标题使用楷体 */
        }
        
        .contents ul {
            list-style: none;
            padding: 0;
        }
        
        .contents li {
            margin: 1.2em 0;
            font-size: 13pt; /* 增大目录字号 */
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif; /* 目录项使用楷体 */
        }
        
        .contents a::after {
            content: " " attr(data-page);
            float: right;
            color: #666;
            font-weight: normal;
        }
        
        /* 荣誉证书部分 - 已移除 */
        
        /* 版权信息 */
        .copyright {
            page: clean;
            text-align: center;
            padding: 2cm 1.5cm;
            color: #666;
        }
        
        .copyright p {
            font-size: 11pt;
            text-indent: 0;
            margin: 1em 0;
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif; /* 版权信息使用楷体 */
        }
        
        /* 图片样式 */
        img {
            display: block;
            margin: 1.5em auto;
            max-width: 80%;
        }
        
        aside {
            display: flex;
            justify-content: center;
        }
        
        aside figure {
            flex: none;
            margin: 0;
            padding: 1em;
            text-align: center;
        }
        
        aside img {
            border: 0.4mm solid white;
            border-radius: 50%;
            margin: 0 auto;
            max-width: 14mm;
        }
        
        /* 水印样式 */
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 60pt;
            color: rgba(128, 128, 128, 0.2);
            font-family: 'CustomKai', "KaiTi", "楷体", "STKaiti", serif;
            z-index: 1000;
            pointer-events: none;
            user-select: none;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <h1>{{ book_info.title }}</h1>
    
    <!-- 水印 -->
    <div class="watermark">{{ book_info.compiler }}</div>
    
    <!-- 封面页 -->
    <section class="cover-page">
        <div class="cover-title">{{ book_info.title }}</div>
        <div class="cover-author">作者 {{ book_info.author }}</div>
    </section>
    
    <!-- 作者信息页 -->
    <section class="author-info">
        <h3>关于作者</h3>
        <p>{{ book_info.author }}，生于1948年5月，松江华阳桥长楼村人。</p>
        <p>一生从事教育工作，从民办教师到食堂管理，见证了时代变迁。</p>
        <p>虽历经坎坷，但始终保持乐观坚韧的人生态度。</p>
        <p>本书记录了他从童年到暮年的人生历程，展现了一个普通人的不凡人生。</p>
    </section>
    
    <!-- 目录页 -->
    <section class="contents">
        <h3>目录</h3>
        <ul>
            {% for chapter in chapters %}
            <li><a href="#chapter-{{ chapter.id }}-title" data-page="{{ chapter.page if chapter.page else '' }}">第{{ chapter.id }}篇 {{ chapter.title }}</a></li>
            {% endfor %}
        </ul>
    </section>
    
    <!-- 各章节内容 -->
    {% for chapter in chapters %}
    <!-- 章节图片页（偶数页，翻开后的左页） -->
    <section class="chapter-image-page">
        <img src="back_cover.jpg" alt="章节配图" class="chapter-image">
    </section>
    
    <!-- 章节内容页（奇数页，翻开后的右页） -->
    <section id="chapter-{{ chapter.id }}" class="chapter chapter-{{ chapter.id }} chapter-content-page">
        <h2 id="chapter-{{ chapter.id }}-title">{{ chapter.title }}</h2>
        
        <!-- 二维码区域 -->
        <div class="chapter-qr">
            {% if chapter.qr_code %}
            <img src="{{ chapter.qr_code }}" alt="{{ chapter.title }}二维码">
            {% else %}
            <img src="qrcode.jpg" alt="{{ chapter.title }}二维码">
            {% endif %}
            <div class="chapter-qr-label">扫码听故事</div>
        </div>
        
        {% for paragraph in chapter.content %}
        <p>{{ paragraph }}</p>
        {% endfor %}
        
        {% if chapter.images %}
        {% for image in chapter.images %}
        <aside>
            <figure>
                <img src="{{ image.url }}" alt="{{ image.alt }}">
                <figcaption>{{ image.caption }}</figcaption>
            </figure>
        </aside>
        {% endfor %}
        {% endif %}
    </section>
    {% endfor %}
    
    <!-- 荣誉证书部分 -->
    <!-- 已移除荣誉证书部分 -->
    
    <!-- 封底页 -->
    <section class="back-cover">
        <div class="back-cover-content">
            <p></p>
        </div>
    </section>
</body>
</html>