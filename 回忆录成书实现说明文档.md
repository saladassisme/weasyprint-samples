# 回忆录成书实现说明文档

## 项目概述

本项目使用WeasyPrint技术栈，将JSON格式的回忆录数据自动转换为精美的PDF书籍。支持动态水印、自动二维码生成、智能分页等高级功能。

## 技术架构

### 核心技术栈
- **WeasyPrint**: Python PDF生成引擎，支持CSS3和HTML5
- **Jinja2**: 模板引擎，用于动态渲染HTML
- **qrcode**: 二维码生成库
- **Pillow**: 图像处理库

### 项目结构
```
weasyprint-samples/
├── biography_data.json          # 回忆录数据源
├── templates/
│   └── biography_book_style_v3.html  # 主要模板文件
├── generate_book_style.py       # 主生成脚本
├── generate_book_style_pre_render.py  # 预渲染版本
├── fonts/                      # 自定义字体目录
├── qr_codes/                   # 自动生成的二维码目录
└── output/                     # PDF输出目录
```

## 功能特性

### 1. 智能分页系统
- **双页布局**: 自动处理左右页布局
- **动态页码**: 预渲染计算真实页码
- **章节分页**: 智能章节起始页控制
- **图片分页**: 章节配图独立页面

### 2. 水印系统
- **动态水印**: 从JSON配置读取水印文案
- **样式控制**: 45°倾斜，透明灰色，高层级显示
- **参数化**: 支持通过`book_info.compiler`字段自定义

### 3. 二维码自动生成
- **链接识别**: 自动检测JSON中的`qr_link`字段
- **批量生成**: 为所有章节自动生成二维码
- **智能回退**: 生成失败时使用默认二维码

### 4. 字体与样式
- **自定义字体**: 支持楷体、宋体等中文字体
- **A5尺寸**: 标准书籍尺寸(140mm × 210mm)
- **专业排版**: 行距、字间距、段落缩进优化

## 数据格式规范

### JSON数据结构
```json
{
  "book_info": {
    "title": "书名",
    "author": "作者",
    "compiler": "水印文案",
    "copyright": "版权信息",
    "contact": {
      "email": "联系邮箱",
      "phone": "联系电话"
    }
  },
  "chapters": [
    {
      "id": 1,
      "title": "章节标题",
      "qr_link": "https://example.com/chapter1",  // 可选：二维码链接
      "content": ["段落1", "段落2", "段落3"],
      "images": [
        {
          "url": "图片路径",
          "alt": "图片描述",
          "caption": "图片说明"
        }
      ]
    }
  ]
}
```

### 字段说明

#### book_info 字段
- `title`: 书籍标题
- `author`: 作者姓名
- `compiler`: 水印文案（如"小鹿光年整理制作"）
- `copyright`: 版权声明
- `contact`: 联系信息

#### chapters 字段
- `id`: 章节编号（必须唯一）
- `title`: 章节标题
- `qr_link`: 二维码链接（可选，自动生成二维码）
- `content`: 章节内容数组
- `images`: 章节图片数组（可选）

## 使用方法

### 1. 环境准备
```bash
# 安装依赖
pip install weasyprint qrcode[pil] jinja2

# 确保字体文件存在
# fonts/custom-title.ttf
# fonts/custom-kai.ttf
```

### 2. 数据准备
1. 编辑`biography_data.json`文件
2. 填入书籍基本信息和章节内容
3. 为需要二维码的章节添加`qr_link`字段

### 3. 生成PDF
```bash
# 基础版本
python generate_book_style.py

# 预渲染版本（更准确的页码）
python generate_book_style_pre_render.py
```

### 4. 输出文件
- **PDF文件**: `output/顾火良回忆录_Book风格_v3_CSS交叉引用版.pdf`
- **调试HTML**: `output/顾火良回忆录_Book风格_v3_CSS交叉引用版_debug.html`
- **二维码图片**: `qr_codes/chapter_X_qr.png`

## 高级功能

### 1. 水印自定义
```json
{
  "book_info": {
    "compiler": "您的水印文案"
  }
}
```

### 2. 二维码批量生成
系统会自动检测JSON中的`qr_link`字段：
- 有链接：自动生成二维码图片
- 无链接：使用默认二维码
- 生成失败：自动回退到默认二维码

### 3. 页码动态计算
- 第一次渲染：生成带页码标记的HTML
- 页码解析：提取真实页码信息
- 第二次渲染：生成带准确目录的最终PDF

## 样式定制

### CSS样式结构
```css
/* 页面设置 */
@page {
    margin: 2cm 2cm 2cm 2cm;
    size: 140mm 210mm;
}

/* 水印样式 */
.watermark {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) rotate(-45deg);
    font-size: 60pt;
    color: rgba(128, 128, 128, 0.2);
    z-index: 1000;
}

/* 章节样式 */
.chapter-content-page {
    page: chapter-content;
    break-before: right;
}
```

### 字体配置
- **标题字体**: CustomTitle (自定义书法字体)
- **正文字体**: 宋体/SimSun
- **楷体字体**: CustomKai (自定义楷体)

## 故障排除

### 常见问题

#### 1. 字体显示问题
```bash
# 检查字体文件是否存在
ls fonts/custom-*.ttf

# 如果字体文件缺失，使用系统字体
# 修改模板中的font-family属性
```

#### 2. 二维码生成失败
```python
# 检查依赖包
pip install qrcode[pil]

# 检查链接格式
# 确保qr_link字段是有效的URL
```

#### 3. PDF生成失败
```bash
# 检查WeasyPrint安装
pip install weasyprint

# 检查HTML语法
# 查看debug.html文件
```

#### 4. 页码计算错误
```python
# 使用预渲染版本
python generate_book_style_pre_render.py

# 检查章节ID是否连续
```

### 调试技巧

1. **查看调试HTML**: 检查`output/*_debug.html`文件
2. **检查二维码**: 查看`qr_codes/`目录中的图片
3. **验证JSON**: 使用JSON验证工具检查数据格式
4. **分步测试**: 先测试单个章节，再测试完整书籍

## 性能优化

### 1. 图片优化
- 使用适当的图片尺寸
- 压缩图片文件大小
- 使用WebP格式（如果支持）

### 2. 内容优化
- 避免过长的段落
- 合理分配章节内容
- 控制图片数量

### 3. 生成优化
- 使用SSD存储
- 增加内存分配
- 关闭不必要的后台程序

## 扩展功能

### 1. 多语言支持
```json
{
  "book_info": {
    "language": "zh-CN",
    "title": "多语言标题"
  }
}
```

### 2. 主题切换
- 创建多个CSS模板
- 支持明暗主题
- 可配置的颜色方案

### 3. 批量处理
```python
# 处理多个JSON文件
for json_file in json_files:
    generate_book_from_json(json_file)
```

## 版本历史

### v3.0 (当前版本)
- ✅ 动态水印系统
- ✅ 自动二维码生成
- ✅ 智能分页计算
- ✅ 预渲染页码系统

### v2.0
- ✅ 基础PDF生成
- ✅ 模板系统
- ✅ 字体支持

### v1.0
- ✅ 基础功能
- ✅ JSON数据支持

## 技术支持

### 联系方式
- **邮箱**: deerlight_ai@163.com
- **电话**: 15301635715

### 更新日志
- 2024-01-XX: 添加二维码自动生成功能
- 2024-01-XX: 实现动态水印系统
- 2024-01-XX: 优化分页算法

---

*本文档持续更新中，如有问题请及时反馈。*
